<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicons -->
  <link rel="icon" href="/logo.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Login | Helpdesk</title>
  <style>
    :root{ --card:#ffffff; --bg:#f7f9fc; --border:#e5e7eb; --muted:#6b7280; --text:#0f172a; --blue:#0d6efd; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans"; background:var(--bg); color:var(--text);}
    .wrap{min-height:100vh; display:grid; place-items:center; padding:24px;}
    .card{width:100%; max-width:400px; padding:32px; border-radius:12px; border:1px solid var(--border); background:var(--card); box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    h1{font-size:1.5rem;font-weight:600;margin-bottom:24px;text-align:center;}
    label{display:block;margin-bottom:4px;font-size:0.875rem;font-weight:500;color:var(--muted)}
    input{width:100%;padding:10px 12px;margin-bottom:16px;border:1px solid var(--border);border-radius:6px;font-size:1rem;color:var(--text);transition:border-color .15s}
    input:focus{outline:2px solid var(--blue);outline-offset:0;border-color:var(--blue)}
    button{width:100%;padding:10px 12px;border:none;border-radius:6px;background:var(--blue);color:white;font-size:1rem;font-weight:600;cursor:pointer;transition:background-color .15s}
    button:hover{background:var(--blue)}
    button:disabled{background:#9ca3af;cursor:not-allowed}
    .err{text-align:center;color:var(--danger);font-size:0.875rem;height:20px;line-height:20px;margin-top:8px}
    .loader{display:inline-block;width:16px;height:16px;border:3px solid #fff;border-radius:50%;border-top-color:transparent;animation:spin .8s linear infinite;margin-right:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script>
    // Redirect if token exists
    (function () {
      try {
        if (localStorage.getItem('enviro_token')) {
          document.documentElement.style.display='none';
          location.replace('/');
        }
      } catch (e) { /* ignore */ }
    })();
  </script>
</head>
<body>

  <div class="wrap">
    <div class="card">
      <h1>Helpdesk Sign In</h1>

      <label for="u">Username</label>
      <input type="text" id="u" placeholder="Enter your username" required>

      <label for="p">Password</label>
      <input type="password" id="p" placeholder="Enter your password" required>

      <button id="btn"><span class="lbl">Sign in</span></button>

      <div id="err" class="err"></div>
    </div>
  </div>

  <script>
    function saveSession(token, user) {
      localStorage.setItem('enviro_token', token);
      localStorage.setItem('enviro_user', user);
    }

    function showErr(msg) {
      document.getElementById('err').textContent = msg;
    }

    function hideErr() {
      document.getElementById('err').textContent = '';
    }

    function setSigning(isSigning) {
      const btn = document.getElementById('btn');
      if (isSigning) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span><span class="lbl">Signing in...</span>';
      } else {
        btn.disabled = false;
        btn.innerHTML = '<span class="lbl">Sign in</span>';
      }
    }

    async function doLogin() {
      const u = document.getElementById('u').value.trim();
      const p = document.getElementById('p').value;
      if (!u || !p) { showErr('Missing username or password.'); return; }

      setSigning(true);
      hideErr();
      try {
        // FIX: Removed ?action=login from URL and added op: 'login' to JSON body.
        const res = await fetch('/api', {
          method: 'POST',
          headers: { 'content-type': 'application/json', 'accept': 'application/json' },
          body: JSON.stringify({ op: 'login', username: u, password: p }), // CRITICAL FIX HERE
          cache: 'no-store'
        });
        
        // Handle non-200 responses (like 401 Unauthorized) gracefully
        const json = await res.json();
        
        if (!json.ok) { 
          showErr(json.error || 'Invalid credentials'); 
          setSigning(false); 
          return; 
        }

        saveSession(json.token, json.role); // NOTE: json.token is used here, assuming GAS returns `token` directly, not `data.token`
        setTimeout(()=>location.replace('/'), 250);
      } catch (err) {
        // This catch block handles genuine network issues (CORS, DNS, connection loss)
        console.error("Login fetch failed:", err);
        showErr('Network error. Please try again.');
        setSigning(false);
      }
    }

    // Wire up events
    document.getElementById('btn').addEventListener('click', doLogin);
    document.addEventListener('keydown', (e)=>{
      const btn = document.getElementById('btn');
      if (e.key === 'Enter') {
        if (btn.disabled) return; // prevent double submit
        doLogin();
      }
    });
    document.getElementById('u').addEventListener('input', hideErr);
    document.getElementById('p').addEventListener('input', hideErr);
  </script>
</body>
</html>
